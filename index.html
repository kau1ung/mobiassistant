<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MobiAssistant</title>
    <style>
        :root { --primary: #3b5bdb; --bg: #f8f9fa; --card: #ffffff; --text: #333; --muted: #adb5bd; --done-bg: #f1f3f5; --danger: #fa5252; }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg); display: flex; height: 100vh; color: var(--text); overflow: hidden; }

        /* ì‚¬ì´ë“œë°” */
        #sidebar { width: 280px; background: white; border-right: 1px solid #eee; display: flex; flex-direction: column; z-index: 10; }
        .logo-area { padding: 30px 25px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f1f3f5; }
        .logo-icon { width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .acc-item { padding: 12px 25px; margin: 2px 15px; border-radius: 12px; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .acc-item.active { background: #edf2ff; color: var(--primary); font-weight: bold; }
        .edit-icon { font-size: 10px; opacity: 0.5; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }

        /* ë©”ì¸ ì˜ì—­ */
        #main { flex: 1; padding: 40px 60px; overflow-y: auto; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; }
        .grid-controls { display: flex; background: #e9ecef; padding: 4px; border-radius: 12px; }
        .grid-btn { border: none; background: none; padding: 8px 18px; border-radius: 9px; font-size: 14px; font-weight: bold; cursor: pointer; color: #666; }
        .grid-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .btn-ui-primary { background: var(--primary); color: white; border: none; padding: 12px 22px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* ìˆ™ì œ ì¹´ë“œ ë° ì •ë ¬ */
        .cat-group { margin-bottom: 40px; }
        .cat-title { font-weight: 800; color: var(--muted); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .hw-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 20px; padding: 25px; border: 1px solid #eee; position: relative; }
        .card.done { background: var(--done-bg); opacity: 0.6; }
        
        .done-label { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 800; margin-top: 15px; }
        .done-label input { width: 22px; height: 22px; margin: 0; cursor: pointer; }

        /* ëª¨ë‹¬ ë° ìºë¦­í„° ì„ íƒ ê·¸ë¦¬ë“œ */
        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:35px; border-radius:30px; width:480px; box-shadow:0 25px 50px rgba(0,0,0,0.2); z-index:100; max-height: 85vh; overflow-y: auto; }
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:90; backdrop-filter: blur(5px); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; }
        
        #accCheckList { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .acc-chk-label { display: flex; align-items: center; padding: 12px; background: white; border: 1px solid #eee; border-radius: 12px; cursor: pointer; }
        .acc-chk-label input { width: 18px; height: 18px; margin-right: 12px; flex-shrink: 0; }
        .acc-chk-label span { font-size: 14px; font-weight: bold; }

        /* ëŒ€ì‹œë³´ë“œ */
        .dash-grid { display: grid; gap: 20px; }
        .acc-card { background: white; border-radius: 25px; padding: 25px; border: 1px solid #eee; }
        .acc-card-title { font-size: 1.3rem; font-weight: 800; text-align: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid #f1f3f5; cursor: pointer; color: var(--primary); }
    </style>
</head>
<body>

<div class="overlay" onclick="closeModal()"></div>

<div class="modal" id="accModal">
    <h2 id="accModalTitle">ğŸ‘¤ ìºë¦­í„° ì„¤ì •</h2>
    <input type="text" id="newAccName" placeholder="ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    <select id="newAccServer">
        <option value="ë˜ì»¨">ë˜ì»¨</option><option value="ë¼ì‚¬">ë¼ì‚¬</option><option value="ì•„ì´ë¼">ì•„ì´ë¼</option>
        <option value="ë°ì´ì•ˆ">ë°ì´ì•ˆ</option><option value="ë©”ì´ë¸">ë©”ì´ë¸</option><option value="ì•Œë¦¬ì‚¬">ì•Œë¦¬ì‚¬</option><option value="ì¹¼ë¦­ìŠ¤">ì¹¼ë¦­ìŠ¤</option>
    </select>
    <div id="accEditBtns" style="display:flex; gap:10px; margin-top:15px;">
        <button onclick="confirmAcc()" class="btn-ui-primary" style="flex:2">ì €ì¥ ì™„ë£Œ</button>
        <button id="accDelBtn" onclick="deleteAcc()" style="flex:1; background:var(--danger); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold;">ì‚­ì œ</button>
    </div>
</div>

<div class="modal" id="hwModal">
    <h2 id="hwModalTitle">ğŸ“‹ ìˆ™ì œ ì„¤ì •</h2>
    <select id="mCat" onchange="updateModalUI()">
        <option value="main">âš”ï¸ ë©”ì¸ ì»¨í…ì¸ </option><option value="trade">âš–ï¸ ë¬¼ë¬¼êµí™˜</option><option value="craft">âš’ï¸ ì œì‘/ì±„ì§‘</option>
    </select>
    <input type="text" id="mName" placeholder="ìˆ™ì œ ì´ë¦„">
    <textarea id="mDesc" placeholder="ì„¤ëª…"></textarea>
    <select id="mCycle">
        <option value="daily">ë§¤ì¼ (06:00 ë¦¬ì…‹)</option><option value="weekly">ë§¤ì£¼ (ì›”ìš”ì¼ 06:00 ë¦¬ì…‹)</option><option value="once">ì¼íšŒì„±</option>
    </select>
    <div id="resFields" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
        <label style="font-weight:bold; font-size:13px;">âš’ï¸ ì œì‘ ì„¸íŠ¸ ë° ì¬ë£Œ</label>
        <input type="number" id="mSets" value="1" min="1" placeholder="ì„¸íŠ¸ ìˆ˜">
        <div id="resContainer"></div>
        <button onclick="addResInput()" style="width:100%; padding:10px; background:#f8f9fa; border:1px solid #eee; border-radius:10px; cursor:pointer; margin-top:10px;">+ ì¬ë£Œ ì¶”ê°€</button>
    </div>
    <div id="accSelectorArea" style="margin-top:20px; background:#f8f9fa; padding:20px; border-radius:20px;">
        <label style="font-size:12px; font-weight:bold; color:#777;">ğŸ‘¥ ì ìš© ìºë¦­í„° ì„ íƒ</label>
        <div id="accCheckList"></div>
    </div>
    <div style="display:flex; gap:10px; margin-top:25px;">
        <button id="hwSaveBtn" class="btn-ui-primary" style="flex:1" onclick="saveHw(false)">ê°œë³„ ì €ì¥</button>
        <button id="hwCommonBtn" class="btn-ui-primary" style="flex:1; background:#343a40;" onclick="saveHw(true)">ê³µìš© ì €ì¥</button>
        <button id="hwDelBtn" style="display:none; flex:0.5; background:var(--danger); color:white; border:none; border-radius:12px; cursor:pointer;" onclick="deleteHw()">ì‚­ì œ</button>
    </div>
</div>

<aside id="sidebar">
    <div class="logo-area" onclick="showDashboard()"><div class="logo-icon">M</div><span style="font-weight:900;">MabiAssistant</span></div>
    <div id="accList" style="flex:1; overflow-y:auto; padding-top:10px;"></div>
    <button onclick="openAccModal()" style="margin:20px; padding:15px; border:2px dashed #eee; background:none; border-radius:15px; cursor:pointer; font-weight:bold; color:var(--muted);">+ ìºë¦­í„° ì¶”ê°€</button>
</aside>

<main id="main"></main>

<script>
    const CAT_INFO = { main: 'âš”ï¸ ë©”ì¸ ì»¨í…ì¸ ', trade: 'âš–ï¸ ë¬¼ë¬¼êµí™˜', craft: 'âš’ï¸ ì œì‘/ì±„ì§‘' };
    let state = JSON.parse(localStorage.getItem('mabiV36')) || { 
        accs: [], accData: {}, cur: -1, commonItems: [], personalItems: {}, isDash: true, lastReset: 0, gridCol: 3
    };
    let editTarget = null; // ìˆ˜ì • ëª¨ë“œ ì¶”ì ìš©

    function save() { localStorage.setItem('mabiV36', JSON.stringify(state)); render(); }

    // [ìˆ˜ì •] ì…ë ¥ì°½ ì´ˆê¸°í™” ë° ë‹«ê¸°
    function closeModal() { 
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
        document.querySelector('.overlay').style.display = 'none';
        editTarget = null;
        // í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('newAccName').value = "";
        document.getElementById('mName').value = "";
        document.getElementById('mDesc').value = "";
        document.getElementById('mSets').value = "1";
        document.getElementById('resContainer').innerHTML = "";
    }

    // [ìºë¦­í„°] ì¶”ê°€ ë° ìˆ˜ì •/ì‚­ì œ
    function openAccModal(accName = null) {
        const title = document.getElementById('accModalTitle');
        const delBtn = document.getElementById('accDelBtn');
        if(accName) {
            title.innerText = "ğŸ‘¤ ìºë¦­í„° ìˆ˜ì •";
            document.getElementById('newAccName').value = accName;
            document.getElementById('newAccServer').value = state.accData[accName].server;
            delBtn.style.display = "block";
            editTarget = accName;
        } else {
            title.innerText = "ğŸ‘¤ ìºë¦­í„° ì¶”ê°€";
            document.getElementById('newAccName').value = "";
            delBtn.style.display = "none";
        }
        document.getElementById('accModal').style.display = 'block'; 
        document.querySelector('.overlay').style.display = 'block';
    }

    function confirmAcc() {
        const newName = document.getElementById('newAccName').value.trim();
        const server = document.getElementById('newAccServer').value;
        if(!newName) return;

        if(editTarget) { // ìˆ˜ì • ëª¨ë“œ
            if(editTarget !== newName) {
                state.accs[state.accs.indexOf(editTarget)] = newName;
                state.accData[newName] = { server };
                delete state.accData[editTarget];
                state.personalItems[newName] = state.personalItems[editTarget];
                delete state.personalItems[editTarget];
            } else {
                state.accData[newName].server = server;
            }
        } else { // ì¶”ê°€ ëª¨ë“œ
            if(!state.accs.includes(newName)) {
                state.accs.push(newName);
                state.accData[newName] = { server };
                state.personalItems[newName] = [];
            }
        }
        closeModal(); save();
    }

    function deleteAcc() {
        if(!editTarget || !confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
        state.accs = state.accs.filter(a => a !== editTarget);
        delete state.accData[editTarget];
        delete state.personalItems[editTarget];
        state.cur = -1;
        state.isDash = true;
        closeModal(); save();
    }

    // [ìˆ™ì œ] ì¶”ê°€ ë° ìˆ˜ì •/ì‚­ì œ
    function openHwModal(item = null, idx = null, type = null) {
        const delBtn = document.getElementById('hwDelBtn');
        const commonBtn = document.getElementById('hwCommonBtn');
        const selector = document.getElementById('accSelectorArea');

        document.getElementById('resContainer').innerHTML = "";
        
        if(item) { // ìˆ˜ì • ëª¨ë“œ
            editTarget = { idx, type };
            document.getElementById('mName').value = item.name;
            document.getElementById('mDesc').value = item.desc || "";
            document.getElementById('mCat').value = item.cat;
            document.getElementById('mCycle').value = item.cycle;
            document.getElementById('mSets').value = item.sets || 1;
            item.mats?.forEach(m => addResInput(m.name, m.count, m.gold));
            delBtn.style.display = "block";
            commonBtn.style.display = "none";
            selector.style.display = "none";
        } else { // ì¶”ê°€ ëª¨ë“œ
            addResInput();
            delBtn.style.display = "none";
            commonBtn.style.display = "block";
            selector.style.display = "block";
            document.getElementById('accCheckList').innerHTML = state.accs.map(acc => `
                <label class="acc-chk-label"><input type="checkbox" class="acc-chk" value="${acc}" ${state.accs[state.cur]===acc?'checked':''}><span>${acc}</span></label>
            `).join('');
        }
        updateModalUI();
        document.getElementById('hwModal').style.display = 'block'; 
        document.querySelector('.overlay').style.display = 'block';
    }

    function addResInput(n='', c='', g='') {
        const div = document.createElement('div');
        div.className = "res-row";
        div.innerHTML = `<input type="text" placeholder="ì¬ë£Œ" class="rn" value="${n}" style="flex:2"><input type="number" placeholder="ê°œ" class="rc" value="${c}" style="flex:1"><input type="number" placeholder="G" class="rg" value="${g}" style="flex:1.5">`;
        document.getElementById('resContainer').appendChild(div);
    }

    function updateModalUI() { document.getElementById('resFields').style.display = (document.getElementById('mCat').value === 'craft') ? 'block' : 'none'; }

    function saveHw(toCommon) {
        const n = document.getElementById('mName').value.trim(); if(!n) return;
        const mats = Array.from(document.querySelectorAll('.res-row')).map(row => ({
            name: row.querySelector('.rn').value, count: Number(row.querySelector('.rc').value)||0, gold: Number(row.querySelector('.rg').value)||0
        })).filter(m => m.name);

        const newItem = { 
            cat: document.getElementById('mCat').value, name: n, desc: document.getElementById('mDesc').value, 
            cycle: document.getElementById('mCycle').value, mats, sets: Number(document.getElementById('mSets').value)||1, 
            done: editTarget ? (editTarget.type === 'common' ? state.commonItems[editTarget.idx].done : state.personalItems[state.accs[state.cur]][editTarget.idx].done) : false
        };

        if(editTarget) {
            if(editTarget.type === 'common') state.commonItems[editTarget.idx] = newItem;
            else state.personalItems[state.accs[state.cur]][editTarget.idx] = newItem;
        } else {
            if(toCommon) state.commonItems.push(newItem);
            else Array.from(document.querySelectorAll('.acc-chk:checked')).map(cb => cb.value).forEach(acc => state.personalItems[acc].push(JSON.parse(JSON.stringify(newItem))));
        }
        closeModal(); save();
    }

    function deleteHw() {
        if(!editTarget || !confirm("ìˆ™ì œë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
        if(editTarget.type === 'common') state.commonItems.splice(editTarget.idx, 1);
        else state.personalItems[state.accs[state.cur]].splice(editTarget.idx, 1);
        closeModal(); save();
    }

    // [ì‹œìŠ¤í…œ] 06:00 ë¦¬ì…‹
    function checkAndReset() {
        const now = new Date();
        let resetPoint = new Date();
        resetPoint.setHours(6, 0, 0, 0);
        if (now.getHours() < 6) resetPoint.setDate(resetPoint.getDate() - 1);
        if (state.lastReset < resetPoint.getTime()) {
            const isMon = (now.getDay() === 1);
            const reset = (list) => list.map(it => { if(it.cycle==='daily' || (it.cycle==='weekly' && isMon)) it.done=false; return it; });
            state.commonItems = reset(state.commonItems);
            state.accs.forEach(acc => state.personalItems[acc] = reset(state.personalItems[acc]));
            state.lastReset = now.getTime();
            save();
        }
    }

    function render() {
        document.getElementById('accList').innerHTML = state.accs.map(n => `
            <div class="acc-item ${(!state.isDash && state.accs[state.cur]===n)?'active':''}" onclick="selectAcc('${n}')">
                <span>${n}</span><span class="edit-icon" onclick="event.stopPropagation(); openAccModal('${n}')">âš™ï¸</span>
            </div>`).join('');

        const main = document.getElementById('main');
        if(state.isDash) {
            main.innerHTML = `<div class="header-row"><h1>ëª¨ë¹„ë…¸ê¸° ìˆ™ì œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1><div class="grid-controls">${[2,3,4].map(v => `<button class="grid-btn ${state.gridCol===v?'active':''}" onclick="state.gridCol=${v};save()">${v}ì—´</button>`).join('')}</div></div>
                <div class="dash-grid" style="grid-template-columns: repeat(${state.gridCol}, 1fr)">
                ${state.accs.map(acc => {
                    const all = [...state.commonItems, ...(state.personalItems[acc] || [])];
                    return `<div class="acc-card"><div class="acc-card-title" onclick="selectAcc('${acc}')">${acc}</div>
                        ${Object.keys(CAT_INFO).map(cat => {
                            const items = all.filter(it => it.cat === cat);
                            return items.length ? `<div style="margin-bottom:10px;"><small style="font-weight:bold;color:var(--muted)">${CAT_INFO[cat].split(' ')[1]}</small>${items.map(it => `<div style="font-size:12px;${it.done?'opacity:0.3;text-decoration:line-through':''}">â€¢ ${it.name}</div>`).join('')}</div>` : '';
                        }).join('')}</div>`;
                }).join('')}</div>`;
        } else {
            const acc = state.accs[state.cur];
            const all = [...state.commonItems.map((it, i) => ({...it, oIdx: i, type: 'common'})), ...(state.personalItems[acc] || []).map((it, i) => ({...it, oIdx: i, type: 'personal'}))];
            main.innerHTML = `<div class="header-row"><h1>${acc} <small style="font-size:14px;color:var(--muted)">(${state.accData[acc].server})</small></h1><button onclick="openHwModal()" class="btn-ui-primary">+ ìˆ™ì œ ì¶”ê°€</button></div>
                ${Object.keys(CAT_INFO).map(cat => {
                    const filtered = all.filter(it => it.cat === cat);
                    return filtered.length ? `<div class="cat-group"><div class="cat-title">${CAT_INFO[cat]}</div><div class="hw-grid">${filtered.map(it => {
                        const totalGold = it.mats?.reduce((s, m) => s + (m.gold * m.count * it.sets), 0) || 0;
                        return `<div class="card ${it.done?'done':''}">
                            <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:bold; color:var(--muted);"><span>${it.cycle.toUpperCase()}</span><span style="cursor:pointer; color:var(--primary)" onclick='openHwModal(${JSON.stringify(it)}, ${it.oIdx}, "${it.type}")'>EDIT</span></div>
                            <div style="font-weight:900; font-size:1.4rem; margin:10px 0;">${it.name}</div>
                            <label class="done-label"><input type="checkbox" ${it.done?'checked':''} onchange="toggleCheck(${it.oIdx}, '${it.type}')"><span>ì™„ë£Œ</span></label>
                            ${it.cat==='craft' ? `<div style="margin-top:15px; font-size:12px; padding:12px; background:#f8f9fa; border-radius:12px;">
                                <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">ğŸ“Š í•©ì‚° ê²°ê³¼ (${it.sets}ì„¸íŠ¸)</div>
                                ${it.mats.map(m => `<div>${m.name}: ${m.count * it.sets}ê°œ</div>`).join('')}
                                <div style="margin-top:8px; border-top:1px dashed #ccc; pt:5px; font-weight:bold;">ì´ ë¹„ìš©: ${totalGold.toLocaleString()} G</div>
                            </div>` : ''}
                        </div>`}).join('')}</div></div>` : '';
                }).join('')}`;
        }
    }

    function toggleCheck(idx, type) {
        const list = (type === 'common' ? state.commonItems : state.personalItems[state.accs[state.cur]]);
        list[idx].done = !list[idx].done; save();
    }
    function showDashboard() { state.isDash = true; save(); }
    function selectAcc(name) { state.cur = state.accs.indexOf(name); state.isDash = false; save(); }

    checkAndReset(); setInterval(checkAndReset, 60000); render();
</script>
</body>
</html>
